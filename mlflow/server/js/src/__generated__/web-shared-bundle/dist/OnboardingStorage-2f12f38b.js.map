{"version":3,"file":"OnboardingStorage-2f12f38b.js","sources":["../src/utils/sharedBrowserUtils.ts","../src/utils/ByteUtils.ts","../src/utils/storage/createStorageMap.ts","../src/utils/storage/OnboardingStorage.ts"],"sourcesContent":["import { truncate } from 'lodash';\n\nimport { RandomUtils } from './RandomUtils';\n\nexport type MeasurementTagValue = string | number | boolean | null | undefined;\nexport interface BrowserUtilsConfigCache {\n  // TODO: Maybe just inject this with bazel instead\n  branch: string;\n}\n\nconst browserTabId = RandomUtils.generateUUID();\n\nlet browserUtilsConfigCache: BrowserUtilsConfigCache | undefined;\n\nexport function setBrowserUtilsConfig(config: BrowserUtilsConfigCache) {\n  browserUtilsConfigCache = config;\n}\n\nexport function getMeasurementTags(additionalTags: { [k: string]: MeasurementTagValue }) {\n  const defaultTags = {\n    browserTabId,\n    browserHasFocus: document.hasFocus(),\n    browserIsHidden: document.hidden,\n    // Keep path truncated to at most UsageLogging.MAX_TAG_LENGTH (see UsageLogging.scala)\n    // To stay compatible with workspace exception naming this is called browserHash\n    browserHash: truncate(window.location.pathname, {\n      length: 200,\n      omission: '[TRUNCATED]',\n    }),\n    browserHostName: window.location.hostname,\n    browserUserAgent: navigator.userAgent,\n    eventWindowTime: window.performance.now(),\n    clientBranchName: browserUtilsConfigCache?.branch,\n  };\n\n  return { ...defaultTags, ...additionalTags };\n}\n","export enum ByteUnit {\n  Bytes = 'Bytes',\n  KiloBytes = 'KiloBytes',\n  MegaBytes = 'MegaBytes',\n  GigaBytes = 'GigaBytes',\n  TeraBytes = 'TeraBytes',\n  PetaBytes = 'PetaBytes',\n  ExaBytes = 'ExaBytes',\n  ZettaBytes = 'ZettaBytes',\n  YottaBytes = 'YottaBytes',\n}\n\nconst byteExponentsMap = {\n  [ByteUnit.Bytes]: 0,\n  [ByteUnit.KiloBytes]: 1,\n  [ByteUnit.MegaBytes]: 2,\n  [ByteUnit.GigaBytes]: 3,\n  [ByteUnit.TeraBytes]: 4,\n  [ByteUnit.PetaBytes]: 5,\n  [ByteUnit.ExaBytes]: 6,\n  [ByteUnit.ZettaBytes]: 7,\n  [ByteUnit.YottaBytes]: 8,\n};\n\nconst sizes = [\n  ByteUnit.Bytes,\n  ByteUnit.KiloBytes,\n  ByteUnit.MegaBytes,\n  ByteUnit.GigaBytes,\n  ByteUnit.TeraBytes,\n  ByteUnit.PetaBytes,\n  ByteUnit.ExaBytes,\n  ByteUnit.ZettaBytes,\n  ByteUnit.YottaBytes,\n];\n\nexport function humanReadableBytes(\n  size: number,\n  unit: ByteUnit = ByteUnit.Bytes,\n): { size: number; sizeUnit: ByteUnit } {\n  // don't parse negative numbers;\n  if (size < 0) {\n    return { size, sizeUnit: unit };\n  }\n\n  // convert to bytes first\n  const bytes = size * Math.pow(1024, byteExponentsMap[unit]);\n  // find the new nearest exponent\n  let exponent = Math.floor(Math.log(bytes) / Math.log(1024));\n  // clamp i between 0 (bytes) and sizes.length - 1 (max supported unit)\n  exponent = Math.min(Math.max(exponent, 0), sizes.length - 1);\n\n  // then find the appropriate unit\n  const numBytes = bytes / Math.pow(1024, exponent);\n  const sizeUnit = sizes[exponent];\n\n  return { size: numBytes, sizeUnit };\n}\n","import type { Serializer, Deserializer, StorageMap } from './types';\n\nexport interface StorageMapArgs<T> {\n  version: number;\n  prefix: string;\n  serializer?: Serializer<T>;\n  deserializer?: Deserializer<T>;\n  storage?: Storage;\n}\n\nconst DEFAULT_SERIALIZER = <T>({ item, version }: { item: T; version: number }) => {\n  return JSON.stringify(item);\n};\n\nconst DEFAULT_DESERIALIZER = <T>({ item, version }: { item: string; version: number }) => {\n  return JSON.parse(item) as T;\n};\n\nexport function createStorageMap<T>({\n  version,\n  prefix,\n  serializer = DEFAULT_SERIALIZER,\n  deserializer = DEFAULT_DESERIALIZER,\n  storage = window.localStorage,\n}: StorageMapArgs<T>): StorageMap<T> {\n  const createKey = (key: string) => `${prefix}${key}`;\n\n  /**\n   * There are two layers of serialization. We let the consumer perform their\n   * custom serialization, and then we serialize that further so we can control\n   * the version / base structure.\n   */\n  const serialize: Serializer<T> = ({ item, version }) => {\n    const serializedItem = serializer({ item, version });\n    return JSON.stringify({ item: serializedItem, version });\n  };\n\n  /**\n   * There are two layers of deserialization: reconstituting our internal\n   * structure, and then reconstituting the consumer's.\n   */\n  const deserialize: ({ storedItem }: { storedItem: string }) => T = ({ storedItem }) => {\n    const { item, version } = JSON.parse(storedItem) as { item: string; version: number };\n    return deserializer({ item, version });\n  };\n\n  return {\n    [Symbol.iterator]: function () {\n      const entries = this.entries();\n\n      let index = 0;\n      return {\n        [Symbol.iterator]: function () {\n          return this;\n        },\n        next: () => {\n          const value = entries[index++];\n          const done = index > entries.length;\n          return { value, done };\n        },\n      };\n    },\n\n    get size() {\n      return this.entries().length;\n    },\n\n    entries() {\n      return Object.entries(storage)\n        .filter(([key]) => key.startsWith(prefix))\n        .map<[string, T]>(([key, value]) => [key.slice(prefix.length), deserialize({ storedItem: value })]);\n    },\n\n    keys() {\n      return this.entries().map(([key]) => key);\n    },\n\n    values() {\n      return this.entries().map(([, value]) => value);\n    },\n\n    forEach(callbackFn: (value: T, key: string, map: StorageMap<T>) => void, thisArg: any) {\n      const entries = this.entries();\n\n      const boundCallback = callbackFn.bind(thisArg);\n\n      for (const [key, value] of entries) {\n        boundCallback(value, key, this);\n      }\n    },\n\n    clear() {\n      const keys = this.keys();\n      for (const key of keys) {\n        this.delete(key);\n      }\n    },\n\n    get(key: string) {\n      const storedItem = storage.getItem(createKey(key));\n      if (!storedItem) return undefined;\n\n      return deserialize({ storedItem });\n    },\n\n    delete(key: string) {\n      storage.removeItem(createKey(key));\n    },\n\n    set(key: string, value: T) {\n      try {\n        storage.setItem(createKey(key), serialize({ item: value, version }));\n      } catch (error) {\n        // Log if quota is exceeded\n        console.error(error);\n      }\n    },\n\n    has(key: string) {\n      return createKey(key) in storage;\n    },\n  };\n}\n","import { createStorageMap } from './createStorageMap';\n\nexport class OnboardingStorage {\n  constructor(private orgId: string | number, private userId: string | number) {}\n\n  private readonly storageMap = createStorageMap<boolean>({\n    version: 1,\n    prefix: `onboarding-user_${this.userId}-org_${this.orgId}-`,\n  });\n\n  get isVisible(): boolean | undefined {\n    return this.storageMap.get('visible');\n  }\n\n  set isVisible(value: boolean | undefined) {\n    this.storageMap.set('visible', value ?? false);\n  }\n\n  get hasSkipped(): boolean {\n    return this.storageMap.get('hasSkipped') ?? false;\n  }\n\n  set hasSkipped(value: boolean) {\n    this.storageMap.set('hasSkipped', value);\n  }\n\n  getOnboardingCheck(check: string): boolean | undefined {\n    return this.storageMap.get(`check-${check}`);\n  }\n\n  setOnboardingCheck(check: string, value: boolean) {\n    this.storageMap.set(`check-${check}`, value);\n  }\n}\n"],"names":["browserTabId","RandomUtils","generateUUID","browserUtilsConfigCache","setBrowserUtilsConfig","config","getMeasurementTags","additionalTags","defaultTags","browserHasFocus","document","hasFocus","browserIsHidden","hidden","browserHash","window","location","pathname","length","omission","browserHostName","hostname","browserUserAgent","navigator","userAgent","eventWindowTime","performance","now","clientBranchName","branch","ByteUnit","byteExponentsMap","Bytes","KiloBytes","MegaBytes","GigaBytes","TeraBytes","PetaBytes","ExaBytes","ZettaBytes","YottaBytes","sizes","humanReadableBytes","size","unit","sizeUnit","bytes","Math","pow","exponent","floor","log","min","max","numBytes","DEFAULT_SERIALIZER","item","version","JSON","stringify","DEFAULT_DESERIALIZER","parse","createStorageMap","prefix","serializer","deserializer","storage","localStorage","createKey","key","serialize","serializedItem","deserialize","storedItem","Symbol","iterator","entries","index","next","value","done","Object","filter","startsWith","map","slice","keys","values","forEach","callbackFn","thisArg","boundCallback","bind","clear","delete","get","getItem","undefined","removeItem","set","setItem","error","console","has","OnboardingStorage","constructor","orgId","userId","isVisible","storageMap","hasSkipped","getOnboardingCheck","check","setOnboardingCheck"],"mappings":"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"}